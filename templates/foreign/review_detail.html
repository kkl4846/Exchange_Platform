{%extends "foreign/foreign_base.html"%}
{%block contents%}
<div class="container2 category-detail">
    <div class="d-flex justify-content-between align-items-end" ">
        <div class="d-flex align-items-end ">
            <h3>{{univ.away_name}}</h3>
            <a class="dark-button country-btn" href="{% url "country:country_wiki" univ.country.pk%}">{{univ.country}}</a>
        </div>
        <a href="{% url "foreign:review_list" univ.pk %}" class="m-btn light-button" style="text-decoration: none;">Î™©Î°ùÎ≥¥Í∏∞</a>
    </div>
    <hr>
    <div class="review-detail-object">
        <div class="d-flex justify-content-between align-items-end review-detail-top">
            <div>
                <span class="review-detail-title">{{review.title}}</span>
                <span class="review-detail-date">{{review.away_year}} {{review.away_semester}}</span>
            </div>
            <div>
                {% if IsReviewAuthor %}
                <button class="light-button create-btn ra_btn" onclick="location.href='{% url "foreign:review_update" univ.pk review.pk%}' ">ÏàòÏ†ï</button>
                    <form action="{% url "foreign:review_delete" univ.pk review.pk %}" method="post" class="ReviewDeleteForm" style="  display: inline; background: transparent">
                        {% csrf_token %}
                        <button class="light-button create-btn " onclick="return confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')" type="submit" >ÏÇ≠Ï†ú</button>
                    </form>
                {% endif %}
            </div>
        </div>
        <div class="review-detail-mid">
            <span class="review-detail-name">{{review.post_author.nickname}}</span>
            <span class="review-detail-date">{{review.created_at|date:"Y.m.d"}}</span>
        </div>
        {{review.content | safe}}
    </div>

    <hr class="review-detail-hr">

    <div class="post_{{review.id}} post">   
        {%if all_comment %}
        {%for comment in all_comment %}
        <div >
            <div class="comment_{{comment.id}} d-flex justify-content-between">
                {{comment.comment_author.nickname}} &#160; &#160; 
                {{comment.comment_content}}
                <div>
                    {% if request.user == comment.comment_author %}
                    <button class="s-btn light-button" onclick="EditComment({{comment.id}} ,'{{comment.comment_content}}')">ÏàòÏ†ï</button>
                    <button class="s-btn light-button" onclick="onClickDelete({{comment.id}} )">ÏÇ≠Ï†ú</button>
                    {%endif%}
                    <button class="s-btn light-button" id='recomment' onclick="recommentPlus('{{comment.pk}}')">ÎåìÍ∏Ä</button><br/>
                </div>
            </div>
        </div>
        <div class="recomment_list_{{ comment.pk }}">
            {% for recomment in recomments  %}
                {% if recomment.comment == comment %}
                <div class="d-flex justify-content-between" id="recomment_{{ recomment.pk }}">
                    <div>
                        <span>üëâ {{ recomment.comment_author.nickname }}</span>
                        <span style="margin-left: 30px;">{{ recomment.comment_content }}</span>
                    </div>
                    {% if recomment.comment_author == request.user %}
                    <div>
                        <button class="s-btn light-button" onclick="editReComment('{{ comment.pk }}', '{{ recomment.pk }}','{{ recomment.comment_content }}')">ÏàòÏ†ï</button>
                        <button class="s-btn light-button" onclick="onClickDeleteUnder('{{ recomment.pk }}')">ÏÇ≠Ï†ú</button>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            {% endfor %}
        </div>
        <div class="recomment_{{ comment.pk }}"></div>
        {%endfor%}
        {%endif%}
    </div>

    <form action="./comment_create/" method="POST">
        {% csrf_token %}
        <input type="text" name="comment_content" id="comment_{{review.id}}" placeholder='ÎãµÎ≥Ä Îã¨Í∏∞...' style="width: 80%;"/>
        <span type="submit" class="blue-button review-detail-submitbtn" onclick="onClickComment('{{user.is_authenticated}}',{{review.id}}, document.querySelector('#comment_{{review.id}}').value)">Îì±Î°ù</span>
        <!-- Ïù¥Ïú†Îäî Î™®Î•¥Í≤†ÏúºÎÇò ÏúÑÏùò Î≤ÑÌäºÏù¥ div,spanÍ∞Ä ÏïÑÎãå button,inputÏù¥Î©¥ Ïò§Î•òÍ∞Ä ÎÇ®,,, -->
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
        const onClickComment= async(is_authenticated,post_id, comment_content) => {  
        console.log(is_authenticated)
            if (is_authenticated == 'False') {
                alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú ÏÑúÎπÑÏä§ÏûÖÎãàÎã§.');
                window.location.href='{% url "login:login" %}';
        }else{
        const url = './comment_create/';
        const res= await fetch(url,{        
            method: 'POST',
            headers:{
            'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: JSON.stringify({is_authenticated:is_authenticated,post_id:post_id,comment_content:comment_content})
        }); 
    
        const {post_id:id,comment_content:content,comment_id:c_id}= await res.json();        
        commentHandleResponse(id,content,c_id);
    }
    };

    const commentHandleResponse=(post_id,comment_content,comment_id) => {
        const element=document.querySelector(`.post_${post_id}`)
        const newDiv = document.createElement('div')
        newDiv.innerHTML = `
        <div class="comment_${comment_id} d-flex justify-content-between">
            {{request.user.nickname}} &#160; &#160; ${comment_content}
            <div>
                <button class="s-btn light-button" onclick="EditComment(${comment_id} ,'${comment_content}')">ÏàòÏ†ï</button>
                <div class="s-btn light-button" onclick="onClickDelete(${comment_id})">ÏÇ≠Ï†ú</div>
                <button class="s-btn light-button" id='recomment' onclick="recommentPlus(${comment_id})">ÎåìÍ∏Ä</button><br/>
            </div>
        </div>
        <div class="recomment_list_${ comment_id }"></div>
        <div class="recomment_${ comment_id }"></div>

        `
        element.appendChild(newDiv)
        //ÎåìÍ∏Ä ÏûÖÎ†•Ï∞Ω ÎπÑÏõåÏ£ºÍ∏∞
        const input_content = document.querySelector(`#comment_${post_id}`)
        input_content.value = null
    }
    
    //ÎåìÍ∏Ä ÏàòÏ†ï
    const EditComment = (comment_id,comment_content)=>{
        const element = document.querySelector(`.comment_${comment_id}`);
        element.innerHTML = ` 
            <input type="text" id="edit_comment" value=${comment_content} class="w-75"/>
            <button class="s-btn blue-button" onclick="onClickUpdate('${comment_id}', document.querySelector('#edit_comment').value)">ÏàòÏ†ï</button>
            `

    }
    const onClickUpdate= async(comment_id,comment_content) => { 
        const allowance =  confirm('ÏàòÏ†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå?'); 
        if (allowance == true) {
        const url = './comment_update/';
        const res= await fetch(url,{        
            method: 'POST',
            headers:{
            'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: JSON.stringify({comment_id:comment_id, comment_content:comment_content})
        }); 
        const {comment_id:id, comment_content:content, nickname:nickname} = await res.json();        
        UpdateHandleResponse(id,content,nickname);
    };
    };

    const UpdateHandleResponse = (comment_id,comment_content,nickname)=>{
        const element = document.querySelector(`.comment_${comment_id}`)
        element.innerHTML = `
        ${nickname} &#160; &#160; 
        ${comment_content}
        <div>
        <button class="s-btn light-button" onclick="EditComment(${comment_id} ,'${comment_content}')">ÏàòÏ†ï</button>
        <button class="s-btn light-button" onclick="onClickDelete(${comment_id} )">ÏÇ≠Ï†ú</button>
        <button class="s-btn light-button" id='recomment' onclick="recommentPlus(${comment_id})">ÎåìÍ∏Ä</button><br/>
        </div>
        `
    }


    //ÎåìÍ∏Ä ÏÇ≠Ï†ú
    const onClickDelete= async(comment_id) => { 
        const allowance =  confirm('Ï†ïÎßêÎ°ú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?'); 
        if (allowance == true) {
        const url = './comment_delete/';
        const res= await fetch(url,{        
            method: 'POST',
            headers:{
            'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: JSON.stringify({comment_id:comment_id})
        }); 
        const {comment_id:id} = await res.json();       
        deleteHandleResponse(id);
    };
    };

    const deleteHandleResponse = (comment_id)=>{
    
        const element = document.querySelector(`.comment_${comment_id}`)
        const element_comment = element.closest('.post')
        element.innerHTML=''
        const recomment = document.querySelector(`.recomment_list_${ comment_id }`)
        if(recomment.innerHTML){
        recomment.innerHTML=''
        }
    }

  //ÎåÄÎåìÍ∏Ä ÏÉùÏÑ±

  const recommentPlus = (comment_id) => {
        const element = document.querySelector(`.recomment_${comment_id}`);
        const originHTML = element.innerHTML;
            
        element.innerHTML = `
            <input type="text" id="new-recomment" placeholder="ÎåìÍ∏Ä Îã¨Í∏∞..." class="w-75"/>
            <button class="s-btn blue-button" onclick="onClickUnderComment('{{is_authenticated}}', ${comment_id}, document.querySelector('#new-recomment').value)">Îì±Î°ù</button>
        `
        }
        
        const onClickUnderComment= async(is_authenticated, comment_id, comment_content) => {  
            if (is_authenticated == 'False') {
                    alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú ÏÑúÎπÑÏä§ÏûÖÎãàÎã§.');
                    window.location.href='{% url "login:login" %}';
            } else {
            const url = './recomment_create/';
            const {data} = await axios.post(url, {
                comment_id,
                comment_content,
            });
            underCommentHandleResponse(data.comment_id, data.recomment_id, data.recomment_author, data.recomment_content);
            }
        };
        const underCommentHandleResponse = (comment_id, recomment_id, recomment_author, recomment_content) => {
                const element = document.querySelector(`.recomment_list_${comment_id}`);
                const newDiv = document.createElement('div')
                newDiv.className = "d-flex justify-content-between";
                newDiv.id = `recomment_${recomment_id}`
                
                newDiv.innerHTML = `
                <div>
                    <span>üëâ ${recomment_author}</span>
                    <span style="margin-left: 30px;">${recomment_content}</span>
                </div>
                <div>
                    <button class="s-btn light-button" onclick="editReComment('${comment_id}', '${recomment_id}','${recomment_content}')">ÏàòÏ†ï</button>
                    <button class="s-btn light-button" onclick="onClickDeleteUnder('${recomment_id}')">ÏÇ≠Ï†ú</button>
                </div>
                `
                element.appendChild(newDiv)
                const input_content = document.querySelector(`.recomment_${comment_id}`);
                input_content.innerHTML = '';
            };
            
            //ÎåÄÎåìÍ∏Ä ÏàòÏ†ï
    const editReComment = (comment_id, recomment_id, recomment_content) => {
        const element = document.querySelector(`.recomment_${comment_id}`);
        const originHTML = element.innerHTML;
            
        element.innerHTML = `
            <input type="text" id="edit-recomment" value=${recomment_content} class="w-75"/>
            <button class="s-btn blue-button" onclick="onClickEditUnder('${comment_id}', '${recomment_id}', document.querySelector('#edit-recomment').value)">Ï†ÄÏû•</button>
        `
    }

    const onClickEditUnder= async(comment_id, recomment_id, comment_content) => {  
        const url = './recomment_update/';
        const {data} = await axios.post(url, {
            comment_id,
            recomment_id,
            comment_content,
        });
        underEditHandleResponse(data.comment_id, data.recomment_id, data.recomment_author, data.recomment_content);
        
    };

    const underEditHandleResponse = (comment_id, recomment_id, recomment_author, recomment_content) => {
        const element = document.querySelector(`#recomment_${recomment_id}`);
        const originHTML = element.innerHTML;

        element.innerHTML = `
        <div>
            <span>üëâ ${recomment_author}</span>
            <span style="margin-left: 30px;">${recomment_content}</span>
        </div>
        <div>
            <button class="s-btn light-button" onclick="editReComment('${comment_id}', '${recomment_id}','${recomment_content}')">ÏàòÏ†ï</button>
            <button class="s-btn light-button" onclick="onClickDeleteUnder('${recomment_id}')">ÏÇ≠Ï†ú</button>
        </div>
        `
        const editInput = document.querySelector(`.recomment_${comment_id}`);
        editInput.innerHTML = '';
    };

   // ÎåÄÎåìÍ∏Ä ÏÇ≠Ï†ú

    const onClickDeleteUnder= async(recomment_id) => {
        const allowance =  confirm('Ï†ïÎßêÎ°ú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?');
        if (allowance == true) {
            const url = './recomment_delete/';
        const {data} = await axios.post(url, {
            recomment_id,
        });
        underDeleteHandleResponse(data.recomment_id);
        }
    };

    const underDeleteHandleResponse = (recomment_id) => {
        const element = document.querySelector(`#recomment_${recomment_id}`);

        element.innerHTML = ``;
    };
</script>
{%endblock%}